<html> <!-- manifest="FieldAppCache.appcache" -->
	<head>
		<title>@10dance Absence Reporting</title>
		<link rel="stylesheet" type="text/css" href="FieldAppCSS.css" />
		<script src="script.js"></script>	
		<script>
			// store all current data upon page close?
			// prompt to leave open if page closes?
			
			window.onload = function() {
				//populate the checkbox list of students
				var array = new Array();
				var curList = storeKeysToArray(studentPrepend, "rank");
				curList.sort();
				for (var i = 0; i < curList.length; i++) {
					var key = curList[i][1];
					var student = new Array(2);
					student[0] = keyDelimiter(key,"netID");
					student[1] = keyDelimiter(key,"name");
					array.push(student);
				}
				listToForm(array);
				
				//clear radio buttons
				document.getElementById("rehearsalRadio").checked = 0;
				document.getElementById("performanceRadio").checked = 0;
				
				if(debug){
					document.getElementById("clear").hidden = false;
				}
				
				//prompt for TA login -- try/catch catcheds error if user refreshes page
				try
				{
					validateTA();
				}
				catch(error)
				{
					parent.location = "FieldAppAbsent.html";
				}
			}
			
			function help(){
				alert("This page is the absence reporting page for the @10dance Mobile App.\n"+
				"\nSelect the event type, a start time, and an end time, and then select the absent students."+
				"Clicking submit will store the event and the absent student records locally."+
				"\n\nThe Tardy Check-In button navigates to the tardy check-in page."+
				"\n\nThe Report Absences button navigates to the absence reporting page."+
				"\n\nThe Upload Attendance Data button uploads the attendance data to the server."+
				"\nUpon successful upload, the local attendance data is cleared."+
				"\n\nBoth reporting absences and uploading attendance data require valid TA login info.");
				return false;
			}
			
			
			/**
			 * Converts an array of arrays into a set of checkboxes, one per
			 * first-dimensional element. The arrays' first element is the netid and
			 * the second dimension is the first and last name together.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/27/12
			 * @param array
			 *            the two-dimensional array from which to build the form
			 */
			function listToForm(array) {

				var form = "<form id='absences' name='absences' method='get'>\n";
				form += "<br><strong>Mark all students that are absent.</strong></br>\n";
				
				for (var i = 0; i < array.length; i++) {
					
					form += '<input type="checkbox" name="student" value="'+array[i][0]+'">'+array[i][1]+'<br>\n';
				}

				form += "</form>";

				document.getElementById("checkboxes").innerHTML = form;            
				
			}
			
			
			/**
			 * Checks that all data entered into the event form is valid and
			 * complete.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/27/12
			 */
			function validate() {
				var r1 = document.getElementById("rehearsalRadio").checked;
				var r2 = document.getElementById("performanceRadio").checked;

				var startHour = parseInt(document.getElementById("startHour").value,10);
				var startMinute = parseInt(document.getElementById("startMinute").value,10);

				var endHour = parseInt(document.getElementById("endHour").value,10);
				var endMinute = parseInt(document.getElementById("endMinute").value,10);

				if (startHour < 1 || startHour > 12) {
					alert("Hours must be entered in the range 1 to 12");
					return false;
				}

				if (endHour < 1 || endHour > 12) {
					alert("Hours must be entered in the range 1 to 12");
					return false;
				}

				if (startMinute < 0 || startMinute > 59) {
					alert("Minutes must be entered in the range 0 to 59");
					return false;
				}

				if (endMinute < 0 || endMinute > 59) {
					alert("Minutes must be entered in the range 0 to 59");
					return false;
				}

				if (!(r1 || r2)) {
					alert("You must select the event type at the top.");
					return false;
				}
				 
				if (!currentTimesAreValid()) {
					alert("Please enter a start time that is before the end time");
					return false;
				}
				 
				return true;
			}
			
			
			
			/**
			 * Checks that the currently entered start time is less than or equal to
			 * the currently entered end time 2/18/12.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/18/12
			 */
			function currentTimesAreValid() {
				var startHour = parseInt(document.getElementById("startHour").value,10);
				var startMinute = parseInt(document.getElementById("startMinute").value,10);

				var endHour = parseInt(document.getElementById("endHour").value,10);
				var endMinute = parseInt(document.getElementById("endMinute").value,10);
				var startPM = document.getElementById("startPM").checked;
				var endPM = document.getElementById("endPM").checked;

				if (startPM) {
					startHour += 12;
				}
				
				if (endPM) {
					endHour += 12;
				}

				if (!startPM && startHour==12) {
					startHour-=12;
				}
				
				if(!endPM && endHour==12) {
					endHour-=12;
				}
							
				if (startHour > endHour) {
					return false;
				}
				
				if (startHour == endHour && startMinute > endMinute) {
					return false;
				}
				
				return true;
			}
			
			/**
			 * Retrieves the type of the current event.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/18/12
			 */
			function getCurrentEventType() {
				var eventFormElements = document.getElementById("event").elements;
				var type = "";
				if (eventFormElements[0].checked == 1) {
					type = eventFormElements[0].value; // rehearsal
				} else if (eventFormElements[1].checked == 1) {
					type = eventFormElements[1].value; // performance
				} else {
					type = null;
				}
				
				return type;
			}
			
			/**
			 * Stores the event currently entered into the form into localStorage.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/18/12
			 */
			function cacheEvent() {
				var type = getCurrentEventType();

				var startTime24 = getCurrentEventStartTime(24);
				var endTime24 = getCurrentEventEndTime(24);
				var startTime12 = getCurrentEventStartTime(12);
				var endTime12 = getCurrentEventEndTime(12);
				
				var entry = type + " " + dateToday() + " " + startTime12 + " " + endTime12;
				var eventPrepend;
				if (type == "rehearsal") {
					eventPrepend = rehearsalPrepend;
				} else {
					eventPrepend = performancePrepend;
				}			
				
				storeEntry(eventPrepend, type, "|", "|", dateToday(), startTime24, endTime24, "|", entry);
				return true;
			}


			/**
			 * Does the same processing as cacheEvent, excepts removes the entry
			 * instead.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/18/12
			 */
			function uncacheEvent() {
				var type = getCurrentEventType();

				var startTime24 = getCurrentEventStartTime(24);
				var endTime24 = getCurrentEventEndTime(24);
				var startTime12 = getCurrentEventStartTime(12);
				var endTime12 = getCurrentEventEndTime(12);
				
				var entry = type + " " + dateToday() + " " + startTime12 + " " + endTime12;
				var eventPrepend;
				if (type == "rehearsal") {
					eventPrepend = rehearsalPrepend;
				} else {
					eventPrepend = performancePrepend;
				}			
				// alert(eventPrepend+" "+type+" "+"|"+" "+"|"+" "+dateToday()+"
				// "+startTime+" "+endTime);
				removeEntry(eventPrepend, type, "|", "|", dateToday(), startTime24, endTime24, "|", entry);
			}

			/**
			 * Gets the start time currently stored into the event form.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/18/12
			 */
			function getCurrentEventStartTime(radix) {
				var startHour = parseInt(document.getElementById("startHour").value,10);
				var startMinute = parseInt(document.getElementById("startMinute").value,10);
				var ampm;
				var isStartPM = document.getElementById("startPM").checked == 1;
				
				if (radix == 12) {
					if(isStartPM)
						ampm = "pm";
					else
						ampm = "am";
					// do nothing, because values are stored in the form
					// in twelve-hour format
				} else if (radix == 24) {
					
					if (isStartPM) {
						startHour += 12;
					}
					if (!isStartPM && startHour==12) {
						startHour -= 12;
					}
					
				}
				// pad for ASCII sorting
				if(startHour<10)
					startHour = "0"+startHour;
				if(startMinute<10)
					startMinute = "0"+startMinute;
				
				if(radix == "12")
					return startHour+":"+startMinute+""+ampm;
				else
					return startHour+""+startMinute;
				
			}
			
			/**
			 * Gets the end time currently stored into the event form.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/18/12
			 */
			function getCurrentEventEndTime(radix) {
				var endHour = parseInt(document.getElementById("endHour").value,10);
				var endMinute = parseInt(document.getElementById("endMinute").value,10);
				var ampm;
				var isEndPM = document.getElementById("endPM").checked == 1;
				
				if (radix == 12) {
					if(isEndPM)
						ampm = "pm";
					else
						ampm = "am";
					// do nothing, because values are stored in the form
					// in twelve-hour format
				} else if (radix == 24) {
					if (isEndPM) {
						endHour += 12;
					}
					if (!isEndPM && endHour==12) {
						endHour -= 12;
					}
					
				}
				// pad for ASCII sorting
				if(endHour<10)
					endHour = "0"+endHour;
				if(endMinute<10)
					endMinute = "0"+endMinute;
			
				if(radix == "12")
					return endHour+":"+endMinute+""+ampm;
				else
					return endHour+""+endMinute;
			}

			
			/**
			 * Clears form and stores contents to localStorage
			 * 
			 * @author Curtis Ullerich
			 * @date 2/18/12
			 */
			function cacheAbsences() {
				var myform = document.getElementById("absences").elements;

				for (var i = 0; i < myform.length; i++) {
				   if (myform[i].checked == 1 && myform[i].type=="checkbox") {

						
						//var firstname = myform[i].value.split(" ")[0];
						//var lastname = myform[i].value.split(" ")[1];
						var netID = myform[i].value;
						var firstname = getFirstName(netID);
						var lastname = getLastName(netID);
						var rank = getRank(netID);
						
						var value = firstname + " " + lastname + " " + dateToday() + " " + getCurrentEventStartTime(12)+" "+getCurrentEventEndTime(12);

						
						
						var absentPrepend = absentPrependPerformance;
						var type = getCurrentEventType();
						if (type == "rehearsal") {
							absentPrepend = absentPrependRehearsal;
						}
						
						storeEntry(absentPrepend, firstname, lastname, netID, dateToday(), getCurrentEventStartTime(24), getCurrentEventEndTime(24), rank, value);
						
						myform[i].checked = 0;
					}
				}
				return true;
			}

			/**
			 * Takes everything from localStorage for the selected rehearsal and
			 * puts it back into the form.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/18/12
			 */
			function repopulateForm() {

				var startTime = parseInt(getCurrentEventStartTime(24),10);   
				var endTime = parseInt(getCurrentEventEndTime(24),10);//

				// search for the event to make sure it happened. If it didn't, then
				// the
				// user should not have clicked edit, so don't allow submission of
				// this data.
				if (!localStorageContainsEvent(getCurrentEventType(), dateToday(), startTime, endTime)) {
					alert("The entered event is not currently cached. No changes were made.");
				   return;
				}
				
				var searchKey = dateToday() + " " + getCurrentEventStartTime(24)+" "+getCurrentEventEndTime(24);
				var sortKey = "key";
				
				var absentPrepend = absentPrependPerformance;
				var type = getCurrentEventType();
				if (type == "rehearsal") {
					absentPrepend = absentPrependRehearsal;
				}
				
				var prepend = absentPrepend;

				var array = storeToArray(prepend, searchKey, sortKey);
				var formElements = document.getElementById("absences").elements;


				for (var i = 0, l = array.length; i<l; i++) {
					var key = array[i][0];// array[i][1];//right? wrong? TODO
					
					// check all keys in the datastore that are absences and match
					// the current date and time.
					// grab the value so we can extract the student's name and set
					// that checkbox.
					var value = array[i][1];

					for (var j = 0; j < formElements.length; j++) {
						// all _vars are from the current form.

						var _prepend = absentPrepend;
	// if (_type == "rehearsal") {
	// _prepend = rehearsalPrepend;
	// }
						var _netID = formElements[j].value;
						var _firstname = getFirstName(_netID);
						var _lastname = getLastName(_netID);                
						var _date = dateToday();
						var _starttime = getCurrentEventStartTime(24);
						var _endtime = getCurrentEventEndTime(24);
						var _entry = "|";
						var _rank = "|";
// alert(_prepend+" "+_firstname+" "+_lastname+" "+_netID+"
// "+_date+" "+_starttime+" "+_endtime+" "+_entry);
// these are from the current key
// var firstname =  keyDelimiter(key,"firstname");
// var lastname = keyDelimiter(key,"lastname");
// var netID = keyDelimiter(key,"netID");
// var startTime = keyDelimiter(key,"starttime");
// var endTime = keyDelimiter(key,"endtime");
// var date = keyDelimiter(key,"date");
// var name = firstname + " " + lastname;
// alert(formElements[j].value + "==" + name);
						var toremove = removeEntry(_prepend,_firstname,_lastname,_netID,_date,_starttime,_endtime,_rank,_entry);
// alert(toremove);
						if (toremove){
							formElements[j].checked = 1;
							break;
						}
					}
				}
// document.getElementById("addOrEditButton").value="Submit Changes";
			}
			
			/**
			* This function shows and hides the absence lists, viewAbsencesOn keeps track of whether the tardy list
			* is being shown
			*
			* @author Todd Wegter
			**/
			//global variable to determine if tardy list is shown
			var viewAbsencesOn = false;
			function absencesOnOff(){
				viewAbsencesOn = !viewAbsencesOn;
				retrieveAbsences();
			}
			
			/**
			* This helper function prints the Absence data to the screen if viewAbsencesOn is true;
			*
			* @author Todd Wegter
			**/
			function retrieveAbsences(){
				if(viewAbsencesOn){
					printEvent();
					printAbsences();
					document.getElementById("viewButton").value = "Hide Absences";
				}
				else{
					document.getElementById("eventDiv").innerHTML = "";
					document.getElementById("absenceDiv").innerHTML = "";
					var table = document.getElementById("absenceTable");
					for(var i = table.rows.length - 1; i >= 0; i--)
					{
						table.deleteRow(i);
					}
					var table = document.getElementById("eventTable");
					for(var i = table.rows.length - 1; i >= 0; i--)
					{
						table.deleteRow(i);
					}
					//changes button text
					document.getElementById("viewButton").value = "View Absences";
				}
				return true;
			}
			
			/**
			 * Inserts the absences currently stored into localStorage into
			 * absenceDiv.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/18/12
			 */
			function printAbsences() {
				//clear existing table
				var table = document.getElementById("absenceTable");
				for(var i = table.rows.length - 1; i >= 0; i--)
				{
					table.deleteRow(i);
				}
				
				var array = storeToArray(absentPrependPerformance,"", "lastname");
				var array2 = storeToArray(absentPrependRehearsal,"", "lastname");
				var array3 = array.concat(array2);
				if(array3.length > 0){
					array3.sort();
					document.getElementById("absenceDiv").innerHTML = "<br>These people have been recorded as absent:</br></br>";
					for (var i = 0; i < array3.length; i++) {
						addRowToTable("1",array3[i][1]);
					}
				}
				else{
					document.getElementById("absenceDiv").innerHTML = "No students have been recorded as absent.";
				}
			}

			/**
			 * Inserts the events currently stored into localStorage into eventDiv.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/18/12
			 */
			function printEvent() {			
				//clear existing table
				var table = document.getElementById("eventTable");
				for(var i = table.rows.length - 1; i >= 0; i--)
				{
					table.deleteRow(i);
				}
				
				var array = storeToArray(performancePrepend, "", "firstname");
				var array2 = storeToArray(rehearsalPrepend, "", "firstname");
				var array3 = array.concat(array2);
				if(array3.length > 0){
					document.getElementById("eventDiv").innerHTML = "<br>Events currently cached:</br></br>";
					array3.sort();
					for (var i = 0; i < array3.length; i++) {
						addRowToTable("0",array3[i][1]);
					}
				}
				else{
					document.getElementById("eventDiv").innerHTML = "</br>No events have been cached.</br></br>";
				}
			}
					
			/**
			 * Clears absence data from localStorage when in debug mode.
			 * 
			 * @author Todd Wegter, Curtis Ullerich
			 * @date 3/22/12
			 */
			function clearAbsences() {
				if(debug)
				{
					//disable buttons while clearing
					document.getElementById("clear").disabled = true;
					document.getElementById("addOrEditButton").disabled = true;
					document.getElementById("viewButton").disabled = true;
					document.getElementById("editMain").disabled = true;
					document.getElementById("clear").value = "Clearing...";
					
					//clear all absence data
					clearLocalStoragewithPrepend(absentPrependPerformance);
					clearLocalStoragewithPrepend(absentPrependRehearsal);
					clearLocalStoragewithPrepend(rehearsalPrepend);
					clearLocalStoragewithPrepend(performancePrepend);
					
					//turn off printed absences
					viewAbsencesOn = false;
					retrieveAbsences();
					
					//wait some time to show disabled buttons in case operation takes very little time
					setTimeout(function(){
						//re-enable buttons
						document.getElementById("clear").disabled = false;
						document.getElementById("addOrEditButton").disabled = false;
						document.getElementById("viewButton").disabled = false;
						document.getElementById("editMain").disabled = false;
						document.getElementById("clear").value = "Clear Absence Data";
					},1000);
				}
				return;
			}
			
			/**
			 * Caches currently entered events and absences.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/18/12
			 */
			function cache() {
				if (validate()) {
					if(cacheEvent() && cacheAbsences() && retrieveAbsences())
						alert("Absence Data Successful Cached Locally");
					else{
						alert("Absence Data Was Not Successfully Cached Locally");
						handleEdit(false);
					}
				}
			}
			
			/**
			 * This function is called when the edit button is pressed.
			 * 
			 * @author Curtis Ullerich
			 * @date 2/18/12
			 */
			function handleEdit(manualEdit) {
				repopulateForm();
				uncacheEvent();
				printEvent();
				printAbsences();
				if(manualEdit)
					alert("The event you entered has been cleared from the cache. \nThe contents of that submission is currently in the form. Click 'submit' to re-cache it.");
			}
			
		</script>
	</head>
    <body>
		<div class="box">
			<h1><b>Absence Report</b></h1><br/>
			
			
			<form id="event" name="event" method="get">
				<strong>Event type </strong>
				<input id="rehearsalRadio" type="radio" name="eventType" value="rehearsal"/>Rehearsal
				<input id="performanceRadio" type="radio" name="eventType" value="performance"/>Performance<br/>
			</form>
			<form id="startAmPm" name="startAmPm" method="get">
				Start time: <input id="startHour" size="5" type="number" name="startHour" min="01" max="12" value="4"/>
					<input id="startMinute" size="5" type="number" name="startMinute" min="00" max="50" step="10" value="30"/>
					<input id="startAM" type="radio" name="startrdio" value="AM"/>AM
					<input id="startPM" type="radio" name="startrdio" value="PM" checked="1"/>PM
			</form>
			<form id="endAmPm" name="endAmPm" method="get">
				End time: <input id="endHour" size="5" type="number" name="endHour" min="01" max="12" value="5"/>
					<input id="endMinute" size="5" type="number" name="endMinute" min="00" max="50" step="10" value="50"/>
					<input id="endAM" type="radio" name="endrdio" value="AM"/>AM
					<input id="endPM" type="radio" name="endrdio" value="PM" checked="1"/>PM
			</form>        
			<br/> Remove the above event: <input class="button" id="editMain" type="submit" value="Remove" onClick="handleEdit(true);"/>

			<hr/>
	
			<div id="checkboxes" class="checkboxes"> 
				<form id="absences" name="absences" method="get">        
					<br><strong>Mark all students that are absent.</strong></br>
				</form>
			</div>
			
			<input class="button" type="submit" id="addOrEditButton" value="Submit" onClick="cache();"/>
			<input class="button" type="button" id="viewButton" value="View Absences" onclick="absencesOnOff();"/>
			
			<input class="back" type="submit" id="back" value="Back" onclick="parent.location='FieldAppMain.html'"/></br>
			<input class="help" type="button" id="help" value="Help" onclick="javascript: help();"/>

			<div id="eventDiv"></div>
			<Table id="eventTable" class="table"> <!-- table 0 -->
				<tbody>
				</tbody>
			</Table>
			<div id="absenceDiv"></div>
			<Table id="absenceTable" class="table"> <!-- table 1 -->
				<tbody>
				</tbody>
			</Table>
			</br>
			<input class="button" type="submit" id="clear" value="Clear Absence Data" onClick="clearAbsences();" hidden=true/>
			</br>
		</div>
    </body>
</html>
