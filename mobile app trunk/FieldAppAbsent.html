<html>
    <script src="script.js"></script>	
	<script>
        //other things TODO
        //add an undo/resubmit button
        //add a view all currently stored (without reloading form)
        //add an edit today"s submission button
        //add validation (like making sure it's a real netid for the tardy form, etc)
        //more meaningful printing
        //how can we prevent localstorage from being cleared?
        //implement sorting of arrays
        //Question: 
        
        //when true, adding new students to the cache also removes any unchecked students
        var currentlyEditing = false;
		
		function validate() {
		    var r1 = document.getElementById("rehearsalRadio").checked;
		    var r2 = document.getElementById("performanceRadio").checked;

   	        if (!(r1 || r2)) {
   	          alert("You must select the event type at the top.");
   	          return false;
   	        } 
   	        return true;
		}
        
        
        function getCurrentEventType(){
            var eventForm = document.getElementById("event").elements;
            var type = "";
            if (eventForm[0].checked == 1) {
                type = eventForm[0].value; //rehearsal
            } else if (eventForm[1].checked == 1) {
                type = eventForm[1].value; //performance
            } else {
                type = null;
            }
            
            return type;
        }
        
        function cacheEvent() {
            var type = getCurrentEventType();


            var startTime = parseInt(getCurrentEventStartTime(),10);// + (document.getElementById("startAM").checked==1 ? 0 : 12);
            if (startTime < 12) {
              startTime = startTime + 12;
            }
            
            var endTime = parseInt(getCurrentEventEndTime(),10);// + (document.getElementById("startPM").checked==1 ? 0 : 12);
            if (endTime < 12) {
                endTime = endTime + 12;
            }
            
            
			var entry = type + " " + dateToday() + " " + startTime + " " + endTime;
			storeEntry(eventPrepend, type, "|", "|", dateToday(), startTime, endTime, entry);
		}
		
		function getCurrentEventStartTime() {
//            var eventForm = document.getElementById("event").elements;
			var startHour = document.getElementById("startHour").value;
            var startMinute = document.getElementById("startMinute").value;
            
            
            
            //TODO: why do we prepend before the hour? Do we want to put a colon here? same below
			if(parseInt(startHour)<10)
				startHour = "0"+startHour;
			if(parseInt(startMinute)<10)
				startMinute = "0"+startMinute;
			
            return startHour+startMinute;
        }
		
		function getCurrentEventEndTime() {
           // var eventForm = document.getElementById("event").elements;
			
            var endHour = document.getElementById("endHour").value;
			var endMinute = document.getElementById("endMinute").value;
			
			if(parseInt(endHour)<10)
				endHour = "0"+endHour;
			if(parseInt(endMinute)<10)
				endMinute = "0"+endMinute;
            return endHour+endMinute;
        }
        
        
        //clears form and stores contents to localStorage
        function cacheAbsences() {
            var myform = document.getElementById("absences").elements;

            for (var i = 0; i < myform.length; i++) {

                    //of the form "netID 2012-12-21"
                    var eventTimes = getCurrentEventStartTime()+" "+getCurrentEventEndTime();
                    var value = myform[i].value + " " + dateToday() + " " + eventTimes;
                    //of the form "absentStudent netID 2012-12-21 1200 1350"
                    var key = absentPrepend + " " + value;

                if (myform[i].type =="checkbox" && currentlyEditing && myform[i].checked == 0) {
                    localStorage.removeItem(key);
                }

               if (myform[i].checked == 1 && myform[i].type=="checkbox") {
                    
                    //this shouldn"t store any duplicates, by nature
                    localStorage.setItem(key,value);
                    
                    myform[i].checked = 0;
                }
            }
            currentlyEditing = false;
            document.getElementById("addOrEditButton").value="Add Absent Students";
        }
        
        //takes everything from localstorage for the selected rehearsal and puts it back into the form
        function repopulateForm() {
            
            //search for the event to make sure it happened
            if (!localStorageContainsEvent(getCurrentEventType(), dateToday(), getCurrentEventStartTime(), getCurrentEventEndTime())) {
                alert("The entered event is not currently cached.");
            }
            
            
            var searchKey = dateToday() + " " + getCurrentEventStartTime()+" "+getCurrentEventEndTime();
            var sortKey = "date";
            var prepend = absentPrepend;

            var array = storeToArray(prepend, searchKey, sortKey);
            
            var form = document.getElementById("absences").elements;
            for (var i = 0, l = array.length; i<l; i++) {
                var key = array[i];
                
//check all keys in the datastore that are absences and match the current date and time
//grab the value so we can extract the student"s name and set that checkbox
                var value = array[i][1];
                for (var j = 0; j < form.length; j++) {
                    if (stringContains(form[j].value,value)) {
                    //they're in the database, so check the box
                        form[j].checked = 1;
                    }
                    
                }
            }
            currentlyEditing = true;
            document.getElementById("addOrEditButton").value="Submit Changes";
            
        }

        function stringifyEvent() {
        }

        function stringifyAbsences() {
        }

        function printAbsences() {
            var str="<br>These people have been recorded as absent:</br>";
            for (var i = 0, l = localStorage.length; i<l; i++) {
                var key = localStorage.key(i);
                if (stringContains(absentPrepend, key)) {
                    var value = localStorage[key];            
                    str+=value + "; ";
                }
            }

            document.getElementById("absenceDiv").innerHTML = str;            
        }

        function printEvent() {
            var str="<br>Events currently cached:</br>";
            for (var i = 0, l = localStorage.length; i<l; i++) {
                var key = localStorage.key(i);
                if (stringContains(eventPrepend, key)) {
                    var value = localStorage[key];
                    str += value + "; ";
                }            
            }
            
            document.getElementById("eventDiv").innerHTML = str;
        }
                
        function clearLocalStorage() {
            localStorage.clear();            
        }
        
        
        function cacheAndPrint() {
            if (validate()) {
                cacheAbsences();
                printAbsences();
                cacheEvent();
                printEvent();
            }
        }
        
        
    </script>

    <body>
        <h1>Marching Band Attendance Report</h1>
        
        <form id="event" name="event" method="get">
            <br><strong>What type of event is this?</strong></br>
            <input id="rehearsalRadio" type="radio" name="eventType" value="rehearsal"/>Rehearsal<br/>
            <input id="performanceRadio" type="radio" name="eventType" value="performance"/>Performance<br/>
        </form>
        <form id="startAmPm" name="startAmPm" method"get">
            Start time: <input id="startHour" type="number" name="startHour" min="01" max="12" value="4"/>
                <input id="startMinute" type="number" name="startMinute" min="00" max="50" step="10" value="30"/>
                <input id="startAM" type="radio" name="AM" value="AM"/>AM
                <input id="startPM" type="radio" name="PM" value="PM" checked="1"/>PM
        </form>
        <form id="endAmPm" name="endAmPm" method"get">
            End time: <input id="endHour" type="number" name="endHour" min="01" max="12" value="5"/>
                <input id="endMinute" type="number" name="endMinute" min="00" max="50" step="10" value="50"/>
                <input id="startAM" type="radio" name="AM" value="AM"/>AM
                <input id="startPM" type="radio" name="PM" value="PM" checked="1"/>PM
        </form>
           <br/> Edit a local submission from a rehearsal that happened today at the above times: <input type="submit" value="Edit!" onClick="repopulateForm();"/>
        
        <form id="absences" name="absences" method="get">        
            <br><strong>Mark all students that are absent.</strong></br>
            <input type="checkbox" name="student" value="Todd Wegter"/>Todd Wegter<br/>
            <input type="checkbox" name="student" value="Curtis Ullerich"/>Curtis Ullerich<br/>
            <input type="checkbox" name="student" value="Fei Zhu"/>Fei Zhu<br/>
            <input type="checkbox" name="student" value="Brandon Maxwell"/>Brandon Maxwell<br/>
        </form>

        <input id="addOrEditButton" type="submit" value="Add Absent Students" onClick="cacheAndPrint();"/>     
        <input type="submit" value="Clear All" onClick="clearLocalStorage();"/>   
        <input type="submit" value="Upload" onClick="upload();"/>   
		
		<div></br></div>
		<input type="submit" id="back" value="Back to Main Page" onclick="parent.location='FieldAppMain.html'"></input></br>

        <div id="eventDiv"></div>
        <div id="absenceDiv"></div>
    </body>
</html>

