<html>
    <script src="script.js"></script>	
	<script>
        //other things TODO
        //add an undo/resubmit button
        //add a view all currently stored (without reloading form)
        //add an edit today"s submission button
        //add validation (like making sure it's a real netid for the tardy form, etc)
        //more meaningful printing
        //how can we prevent localstorage from being cleared?
        //implement sorting of arrays
        
        //when true, adding new students to the cache also removes any unchecked students
        var currentlyEditing = false;
		
        
        function cacheEvent() {
            var eventForm = document.getElementById("event").elements;
            var type = "";
            if (eventForm[0].checked == 1) {
                type = eventForm[0].value; //rehearsal
            } else {
                type = eventForm[1].value; //performance
            }
            
			var entry = type + " " + dateToday() + " " + getCurrentEventStartTime() + " " + getCurrentEventEndTime();
			storeEntry(eventPrepend, "|", "|", "|", dateToday(), getCurrentEventStartTime(), getCurrentEventEndTime(), entry);
		}
		
		function getCurrentEventStartTime() {
            var eventForm = document.getElementById("event").elements;
			var startHour = eventForm[2].value;
            var startMinute = eventForm[3].value;
            
			if(parseInt(startHour)<10)
				startHour = "0"+startHour;
			if(parseInt(startMinute)<10)
				startMinute = "0"+startMinute;
			
            return startHour+startMinute;
        }
		
		function getCurrentEventEndTime() {
            var eventForm = document.getElementById("event").elements;
			
            var endHour = eventForm[4].value;
			var endMinute = eventForm[5].value;
			
			if(parseInt(endHour)<10)
				endHour = "0"+endHour;
			if(parseInt(endMinute)<10)
				endMinute = "0"+endMinute;
            return endHour+endMinute;
        }
              

        //clears form and stores contents to localStorage
        function cacheAbsences() {
            var myform = document.getElementById("absences").elements;

            for (var i = 0; i < myform.length; i++) {

                    //of the form "netID 2012-12-21"
                    var eventTimes = getCurrentEventStartTime()+" "+getCurrentEventEndTime();
                    var value = myform[i].value + " " + dateToday() + " " + eventTimes;
                    //of the form "absentStudent netID 2012-12-21 1200 1350"
                    var key = absentPrepend + " " + value;

                if (myform[i].type =="checkbox" && currentlyEditing && myform[i].checked == 0) {
                    localStorage.removeItem(key);
                }

               if (myform[i].checked == 1 && myform[i].type=="checkbox") {
                    
                    
                    //this shouldn"t store any duplicates, by nature
                    localStorage.setItem(key,value);
                    
                    myform[i].checked = 0;
                }
            }
            currentlyEditing = false;
        }
        
        //takes everything from localstorage for the selected rehearsal and puts it back into the form
        function repopulateForm() {
            
            var searchKey = dateToday() + " " + getCurrentEventStartTime()+" "+getCurrentEventEndTime();
            var sortKey = "date";
            var prepend = absentPrepend;

            var array = storeToArray(prepend, searchKey, sortKey);
            for (var j = 0; j < form.length; j++) {
                
                
                
            }
            
            
/*            var form = document.getElementById("absences").elements;
            for (var i = 0, l = localStorage.length; i<l; i++) {
                var key = localStorage.key(i);
                
                //check all keys in the datastore that are absences and match the current date and time
                if (stringContains(searchKey, key) && stringContains(absentPrepend, key)) {
                    //grab the value so we can extract the student"s name and set that checkbox
                    var value = localStorage[key];
                    for (var j = 0; j < form.length; j++) {
                        if (stringContains(form[j].value,value)) {
                            //theyre in the database, so check the box
                            form[j].checked = 1;
                        }
                        
                    }
                }
            }*/
            currentlyEditing = true;
        }

        function stringifyEvent() {
        }

        function stringifyAbsences() {
        }

        function printAbsences() {
            var str="<br>These people have been recorded as absent:</br>";
            for (var i = 0, l = localStorage.length; i<l; i++) {
                var key = localStorage.key(i);
                if (stringContains(absentPrepend, key)) {
                    var value = localStorage[key];            
                    str+=value + "; ";
                }
            }

            document.getElementById("absenceDiv").innerHTML = str;            
        }

        function printEvent() {
            var str="<br>Events currently cached:</br>";
            for (var i = 0, l = localStorage.length; i<l; i++) {
                var key = localStorage.key(i);
                if (stringContains(eventPrepend, key)) {
                    var value = localStorage[key];
                    str += value + "; ";
                }            
            }
            
            document.getElementById("eventDiv").innerHTML = str;
        }
                
        function clearLocalStorage() {
            localStorage.clear();            
        }
        
        
        function cacheAndPrint() {
            cacheAbsences();
            printAbsences();
            cacheEvent();
            printEvent();
        }
        
        
    </script>

    <body>
        <h1>Marching Band Attendance Report</h1>
        
        <form id="event" name="event" method="get">
            <br><strong>What type of event is this?</strong></br>
            <input type="radio" name="eventType" value="rehearsal"/>Rehearsal<br/>
            <input type="radio" name="eventType" value="performance"/>Performance<br/>
            Start time: <input type="number" name="startHour" min="00" max="23" value="16"/>
                <input type="number" name="startMinute" min="00" max="50" step="10" value="30"/>
            End time: <input type="number" name="endHour" min="00" max="23" value="17"/>
                <input type="number" name="endMinute" min="00" max="50" step="10" value="50"/>
        </form>
           <br/> Edit a local submission from a rehearsal that happened today at the above times: <input type="submit" value="Edit!" onClick="repopulateForm();"/>
        
        <form id="absences" name="absences" method="get">        
            <br><strong>Mark all students that are absent.</strong></br>
            <input type="checkbox" name="student" value="Todd Wegter"/>Todd Wegter<br/>
            <input type="checkbox" name="student" value="Curtis Ullerich"/>Curtis Ullerich<br/>
            <input type="checkbox" name="student" value="Fei Zhu"/>Fei Zhu<br/>
            <input type="checkbox" name="student" value="Brandon Maxwell"/>Brandon Maxwell<br/>
        </form>

        <input type="submit" value="Add Absent Students" onClick="cacheAndPrint();"/>     
        <input type="submit" value="Clear All" onClick="clearLocalStorage();"/>   
        <input type="submit" value="Upload" onClick="upload();"/>   
		
		<div></br></div>
		<input type="submit" id="back" value="Back to Main Page" onclick="parent.location='FieldAppMain.html'"></input></br>

        <div id="eventDiv"></div>
        <div id="absenceDiv"></div>
    </body>
</html>

