<html>
    <link rel="stylesheet" type="text/css" href="FieldAppCSS.css" />
    <script src="script.js"></script>	
	<script>
        //other things TODO
        //add an undo/resubmit button
        //add a view all currently stored (without reloading form)
        //add an edit today"s submission button
        //more meaningful printing
        //how can we prevent localstorage from being cleared?
        //We need to formalize all handling of time. Pick a 12-hour format and modify every instance of it to match that. Make it human-readable.
        //store all current data upon page close?
        //prompt to leave open if page closes?

//        window.onload = junk;
        window.onload = function() {
//            listToForm(new Array("Todd Wegter","Curtis Ullerich","Brandon Maxwell",
    //            "Yifei Zhu", "Simanta Mitra","Steven Smyth"));

            //TODO will need to be able to sort by rank
            //students is a 2d array each element has an array of [netID, valueFromlocalStorage]
            var array = new Array();
            for (var i = 0; i < localStorage.length; i++) {
                var key = localStorage.key(i);
                var student = new Array(2);
                student[0] = keyDelimiter(key,"netID");
                student[1] = keyDelimiter(key,"name");
                array.push(student);
            }
            listToForm(array);
        }
        
        //converts an array of strings into a set of checkboxes, one per string
        function listToForm(array) {

            var form = "<form id='absences' name='absences' method='get'>\n";
            form += "<br><strong>Mark all students that are absent.</strong></br>\n";
            
            for (var i = 0; i < array.length; i++) {
                
                form += '<input type="checkbox" name="student" value="'+array[i][0]+'">'+array[i][1]+'<br>\n';
            }

            form += "</form>";

            document.getElementById("checkboxes").innerHTML = form;            
            
        }
        
        //checks that all data entered is valid and complete		
		function validate() {
		    var r1 = document.getElementById("rehearsalRadio").checked;
		    var r2 = document.getElementById("performanceRadio").checked;

			var startHour = parseInt(document.getElementById("startHour").value,10);
            var startMinute = parseInt(document.getElementById("startMinute").value,10);

			var endHour = parseInt(document.getElementById("endHour").value,10);
            var endMinute = parseInt(document.getElementById("endMinute").value,10);

            if (startHour < 1 || startHour > 12) {
                alert("Hours must be entered in the range 1 to 12");
                return false;
            }

            if (endHour < 1 || endHour > 12) {
                alert("Hours must be entered in the range 1 to 12");
                return false;
            }

            if (startMinute < 0 || startMinute > 59) {
                alert("Minutes must be entered in the range 0 to 59");
                return false;
            }

            if (endMinute < 0 || endMinute > 59) {
                alert("Minutes must be entered in the range 0 to 59");
                return false;
            }

   	        if (!(r1 || r2)) {
   	            alert("You must select the event type at the top.");
     	        return false;
   	        }
   	         
   	        if (!currentTimesAreValid()) {
   	            alert("Please enter a start time that is before the end time");
   	            return false;
   	        }
   	         
   	        return true;
		}
        
        
        //checks that the currently entered start time is less than or equal to the currently entered end time 2/18/12
        function currentTimesAreValid() {
      		var startHour = parseInt(document.getElementById("startHour").value,10);
            var startMinute = parseInt(document.getElementById("startMinute").value,10);

			var endHour = parseInt(document.getElementById("endHour").value,10);
            var endMinute = parseInt(document.getElementById("endMinute").value,10);
            var startPM = document.getElementById("startPM").checked;
            var endPM = document.getElementById("endPM").checked;

            if (startPM) {
                startHour += 12;
            }
            
            if (endPM) {
                endHour += 12;
            }

            if (!startPM && startHour==12) {
                startHour-=12;
            }
            
            if(!endPM && endHour==12) {
                endHour-=12;
            }
                        
            if (startHour > endHour) {
                return false;
            }
            
            if (startHour == endHour && startMinute > endMinute) {
                return false;
            }
            
            return true;
        }
        
        function getCurrentEventType() {
            var eventFormElements = document.getElementById("event").elements;
            var type = "";
            if (eventFormElements[0].checked == 1) {
                type = eventFormElements[0].value; //rehearsal
            } else if (eventFormElements[1].checked == 1) {
                type = eventFormElements[1].value; //performance
            } else {
                type = null;
            }
            
            return type;
        }
        
        function cacheEvent() {
            var type = getCurrentEventType();

            var startTime = parseInt(getCurrentEventStartTime(24),10);
            var endTime = parseInt(getCurrentEventEndTime(24),10);
            
			var entry = type + " " + dateToday() + " " + startTime + " " + endTime;
			var eventPrepend;
			if (type == "rehearsal") {
                eventPrepend = rehearsalPrepend;
            } else {
                eventPrepend = performancePrepend;
            }			
			
			storeEntry(eventPrepend, type, "|", "|", dateToday(), startTime, endTime, entry);
		}

//does the same processing as cacheEvent, excepts removes the entry instead
        function uncacheEvent() {
            var type = getCurrentEventType();

            var startTime = parseInt(getCurrentEventStartTime(24),10);
            var endTime = parseInt(getCurrentEventEndTime(24),10);
            
			var entry = type + " " + dateToday() + " " + startTime + " " + endTime;
			var eventPrepend;
			if (type == "rehearsal") {
                eventPrepend = rehearsalPrepend;
            } else {
                eventPrepend = performancePrepend;
            }			
			//alert(eventPrepend+" "+type+" "+"|"+" "+"|"+" "+dateToday()+" "+startTime+" "+endTime);
			removeEntry(eventPrepend, type, "|", "|", dateToday(), startTime, endTime, entry);
        }

		function getCurrentEventStartTime(radix) {
            var startHour = parseInt(document.getElementById("startHour").value,10);
            var startMinute = parseInt(document.getElementById("startMinute").value,10);

            if (radix == 12) {
                //do nothing, because values are stored in the form
                //in twelve-hour format
            } else if (radix == 24) {
                var isStartPM = document.getElementById("startPM").checked == 1;
                if (isStartPM) {
                    startHour += 12;
                }
                if (!isStartPM && startHour==12) {
                    startHour -= 12;
                }
                
            }
            //pad for ASCII sorting
   			if(startHour<10)
   				startHour = "0"+startHour;
   			if(startMinute<10)
   				startMinute = "0"+startMinute;
		
            return startHour+""+startMinute;//to make sure it's a string?
        }
		
		function getCurrentEventEndTime(radix) {
            var endHour = parseInt(document.getElementById("endHour").value,10);
            var endMinute = parseInt(document.getElementById("endMinute").value,10);

            if (radix == 12) {
                //do nothing, because values are stored in the form
                //in twelve-hour format
            } else if (radix == 24) {
                var isEndPM = document.getElementById("endPM").checked == 1;
                if (isEndPM) {
                    endHour += 12;
                }
                if (!isEndPM && endHour==12) {
                    endHour -= 12;
                }
                
            }
            //pad for ASCII sorting
   			if(endHour<10)
   				endHour = "0"+endHour;
   			if(endMinute<10)
   				endMinute = "0"+endMinute;
		
            return endHour+""+endMinute;//to make sure it's a string?
        }

        //clears form and stores contents to localStorage
        function cacheAbsences() {
            var myform = document.getElementById("absences").elements;

            for (var i = 0; i < myform.length; i++) {
               if (myform[i].checked == 1 && myform[i].type=="checkbox") {

                    var value = myform[i].value + " " + dateToday() + " " + getCurrentEventStartTime(24)+" "+getCurrentEventEndTime(24);
                    
                    var firstname = myform[i].value.split(" ")[0];
                    var lastname = myform[i].value.split(" ")[1];
                    
                    var absentPrepend = absentPrependPerformance;
                    var type = getCurrentEventType();
                    if (type == "rehearsal") {
                        absentPrepend = absentPrependRehearsal;
                    }
                    
                    storeEntry(absentPrepend, firstname, lastname, "|", dateToday(), getCurrentEventStartTime(24), getCurrentEventEndTime(24), value);
                    
                    myform[i].checked = 0;
                }
            }
        }

        //takes everything from localstorage for the selected rehearsal and puts it back into the form
        function repopulateForm() {

            var startTime = parseInt(getCurrentEventStartTime(24),10);   
            var endTime = parseInt(getCurrentEventEndTime(24),10);//

            //search for the event to make sure it happened. If it didn't, then the user should not have clicked edit, so don't allow submission of this data.
            if (!localStorageContainsEvent(getCurrentEventType(), dateToday(), startTime, endTime)) {
                alert("The entered event is not currently cached. No changes were made.");
               return;
            }
            
            var searchKey = dateToday() + " " + getCurrentEventStartTime(24)+" "+getCurrentEventEndTime(24);
            var sortKey = "key";
            
            var absentPrepend = absentPrependPerformance;
            var type = getCurrentEventType();
            if (type == "rehearsal") {
                absentPrepend = absentPrependRehearsal;
            }

            
            var prepend = absentPrepend;

            var array = storeToArray(prepend, searchKey, sortKey);
            var formElements = document.getElementById("absences").elements;


            for (var i = 0, l = array.length; i<l; i++) {
                var key = array[i][0];//array[i][1];//right? wrong? TODO 
                
//check all keys in the datastore that are absences and match the current date and time.
//grab the value so we can extract the student's name and set that checkbox.
                var value = array[i][1];

                for (var j = 0; j < formElements.length; j++) {
                    //all _vars are from the current form.

                    var _prepend = absentPrepend;
//                    if (_type == "rehearsal") {
  //                      _prepend = rehearsalPrepend;
    //                }
                    var _firstname = formElements[j].value.split(" ")[0];
                    var _lastname = formElements[j].value.split(" ")[1];                
                    var _date = dateToday();
                    var _netID = "|";
                    var _starttime = getCurrentEventStartTime(24);
                    var _endtime = getCurrentEventEndTime(24);
                    var _entry = "|";
             //       alert(_prepend+" "+_firstname+" "+_lastname+" "+_netID+" "+_date+" "+_starttime+" "+_endtime+" "+_entry);
                    //these are from the current key
                    var firstname =  keyDelimiter(key,"firstname");
                    var lastname = keyDelimiter(key,"lastname");
//                    var netID = keyDelimiter(key,"netID");
//                    var startTime = keyDelimiter(key,"starttime");
//                    var endTime = keyDelimiter(key,"endtime");
//                    var date = keyDelimiter(key,"date");
                    var name = firstname + " " + lastname;
//                  //  alert(formElements[j].value + "==" + name);
                    var toremove = removeEntry(_prepend,_firstname,_lastname,_netID,_date,_starttime,_endtime,_entry);
                //    alert(toremove);
                    if (toremove){
                        formElements[j].checked = 1;
                        break;
                    }
                }
            }
//            document.getElementById("addOrEditButton").value="Submit Changes";            
        }

        function stringifyEvent() {
        }

        function stringifyAbsences() {
        }

        function printAbsences() {
            var str="<br>These people have been recorded as absent:</br>";
            var array = storeToArray(absentPrependPerformance," ","date");
            var array2 = storeToArray(absentPrependRehearsal," ","date");
            var array3 = array.concat(array2);
            for (var i = 0; i < array3.length; i++) {
                str+=array3[i][1] + "; ";
            }

            document.getElementById("absenceDiv").innerHTML = str;
        }

        function printEvent() {
            var str="<br>Events currently cached:</br>";
            for (var i = 0, l = localStorage.length; i<l; i++) {
                var key = localStorage.key(i);
                if (stringContains(rehearsalPrepend, key) || stringContains(performancePrepend,key)) {
                    var value = localStorage[key];
                    str += value + "; ";
                }            
            }

            document.getElementById("eventDiv").innerHTML = str;
        }
                
        function clearLocalStorage() {
            localStorage.clear();   
            document.getElementById("eventDiv").innerHTML = "";
            document.getElementById("absenceDiv").innerHTML = "";
        }
        
        function cacheAndPrint() {
            if (validate()) {
                cacheEvent();
                cacheAbsences();
                printAbsences();
                printEvent();
            }
        }
        
        function handleEdit() {
            repopulateForm();
            uncacheEvent();
            printAbsences();
            printEvent();
            alert("The event you entered has been cleared from the cache. \nThe contents of that submission is currently in the form. Click 'submit' to re-cache it.");
        }
        
    </script>

    <body class="box">
        <h1><b>Absence Report</b></h1><br/>
        
        
        <form id="event" name="event" method="get">
            <strong>Event type </strong>
            <input id="rehearsalRadio" type="radio" name="eventType" value="rehearsal"/>Rehearsal
            <input id="performanceRadio" type="radio" name="eventType" value="performance"/>Performance<br/>
        </form>
        <form id="startAmPm" name="startAmPm" method="get">
            Start time: <input id="startHour" size="5" type="number" name="startHour" min="01" max="12" value="4"/>
                <input id="startMinute" size="5" type="number" name="startMinute" min="00" max="50" step="10" value="30"/>
                <input id="startAM" type="radio" name="startrdio" value="AM"/>AM
                <input id="startPM" type="radio" name="startrdio" value="PM" checked="1"/>PM
        </form>
        <form id="endAmPm" name="endAmPm" method="get">
            End time: <input id="endHour" size="5" type="number" name="endHour" min="01" max="12" value="5"/>
                <input id="endMinute" size="5" type="number" name="endMinute" min="00" max="50" step="10" value="50"/>
                <input id="endAM" type="radio" name="endrdio" value="AM"/>AM
                <input id="endPM" type="radio" name="endrdio" value="PM" checked="1"/>PM
        </form>        
           <br/> Remove the above event: <input id="editMain" type="submit" value="Remove" onClick="handleEdit();"/>

<hr/>
        <div id="checkboxes" class="leftalign">        
            <form id="absences" name="absences" method="get">        
                <br><strong>Mark all students that are absent.</strong></br>
                <input type="checkbox" name="student" value="Todd Wegter"/>Todd Wegter<br/>
                <input type="checkbox" name="student" value="Curtis Ullerich"/>Curtis Ullerich<br/>
                <input type="checkbox" name="student" value="Fei Zhu"/>Fei Zhu<br/>
                <input type="checkbox" name="student" value="Brandon Maxwell"/>Brandon Maxwell<br/>
            </form>
        </div>

        <input class="leftalign" id="addOrEditButton" type="submit" value="Submit" onClick="cacheAndPrint();"/>     
        <input class="rightalign" type="submit" value="Clear All" onClick="clearLocalStorage();"/>   
		
		<div></br></div>
		<input class="back" type="submit" id="back" value="Back" onclick="parent.location='FieldAppMain.html'"></input></br>
		<input class="help" type="button" id="help" value="Help" onclick="javascript: help();"/>

        <div id="eventDiv"></div>
        <div id="absenceDiv"></div>
    </body>
</html>
